---
  - hosts: appserver
    become: true
    tasks:
      - name: Install aptitude using apt
        apt: name=aptitude state=latest update_cache=yes force_apt_get=yes

      - name: Install required system packages
        apt: name={{item}} state=latest update_cache=yes
        with_items:
          - apt-transport-https
          - ca-certificates
          - curl
          - software-properties-common
          - python-pip
          - virtualenv
          - python-setuptools
          - iptables

      - name: Add Docker GPG apt Key
        apt_key:
          url: https://download.docker.com/linux/ubuntu/gpg
          state: present

      - name: Add Docker Repository
        apt_repository:
          repo: deb https://download.docker.com/linux/ubuntu bionic stable
          state: present

      - name: Update apt and install docker-ce
        apt: update_cache=yes name=docker-ce state=latest

      - name: Ensure docker is started
        service: name=docker state=started enabled=yes

      - name: Create "docker" group
        group:
          name: docker
          state: present


      - name: Add remote "ansible" user to "docker" group
        user:
          name: ansible
          group: docker
          append: yes

      - name: Install docker-compose
        get_url:
          url : https://github.com/docker/compose/releases/download/1.21.2/docker-compose-Linux-x86_64
          dest: /usr/bin/docker-compose
          mode: 'u+x,g+x'

      - name: Install Docker Module for Python
        pip: name={{item}}
        with_items:
          - docker
          - pyyaml

      - name: Copy application
        copy:
          src: application
          dest: /home/ansible/
          mode: 0755
        notify: Deploy

    handlers:
      - name: Deploy
        docker_compose: project_src=/home/ansible/application build=yes state=present
